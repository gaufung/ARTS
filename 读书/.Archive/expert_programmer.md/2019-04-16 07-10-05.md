---
title: 程序是如何运行起来的？
status: draft
date:  2019-04-09
---
# 1 背景
对于最简单的应用程序 `Hello World`, C 语言是这么实现的
```c
#include<stdio.h>
int main()
{
    printf("Hello World\n");
    return 0;
}
```
通过 `GCC` 或者 `MSVC` 编译后，就可以得到可执行文件，在操作系统执行该文件后，就会输出 `Hello World`。那么问题来了，这个应用程序是如何从编写的代码转换为计算机的输出？下面是中间包含的所有可能的问题：
1. 编译器做了哪些工作？
2. 可执行文件中包含了那些东西？是怎么组织的？
3. 不同的编译器在不同的平台下生成的文件是一样的吗？是如何同操作系统进行交互的？
4. 程序的入口在哪？计算机是如何一步步执行代码的？
5. 程序在执行的过程中如何使用 `CPU` 和内存的？
## 1.1 编译
使用 `gcc hello.c` 或者 `Visual Studio` 中的 `build` 按钮，就可以完成整个编译工作，但是**魔鬼隐藏在细节中**， 这个过程差不多包含了 4 个主要步骤：
1. 预编译
2. 编译
3. 汇编
4. 链接

### 1.1.1 预编译
预编译主要处理源代码中 `#` 开始预编译指令
- 展开所有的 `#define` 的宏定义；
- 根据编译条件，处理所有的的 `#if`, `#ifdef`, `#elif`, `#else` 等条件编译；
- 处理 `#include` 包含的指令，展开所有引用的文件；
- ...

### 1.1.2 编译
这个过程是构建应用程序核心过程，也是目前编译器相关研究关注的内容，它将源代码转为汇编代码，主要包含的流程有：
- 词法分析：源码转换为一系列预先定义好的 `Token`。
- 语法分析：对上一步构建好的 `Token` 进行语法分析，生成一个抽象语法树(`Abstract Syntax Tree, AST`)。
- 语义分析：如果是静态语言，需要在编译的时候确定语法树是否有意义；如果是动态语言，这一步将交给运行的时候判断。
- 中间语言生成：将抽象语法树转换为中间代码，它是其顺序表示。中间代码通常有: `三地址码` 和 `P-代码`。
- 目标代码生成：将中间代码转换为目标机器的汇编代码。

上述整个过程按照中间代码分为前端和后端，前端负责将源代码转换为中间代码，后端将中间代码转换为目标机器码。
对于编译部分可以参考以下资料:
- [Compile Principle](https://book.douban.com/subject/5416783/)
- [Write An Interpreter in Go](https://book.douban.com/subject/27034273/)
- [Writing A Compiler In Go](https://book.douban.com/subject/30303705/)

### 1.1.3 汇编
汇编过程将汇编代码转为相应的机器代码，这个过程比较简单，因为每个汇编代码都对应相应的机器代码，只需要一一翻译即可。
### 1.1.4 链接
现代软件是一项巨大的工程，通常是由多人共同的协作完成，每个人负责其中的一个模块。在 `C` 语言项目中，每个 `.c` 文件对应一个模块，如果在代码中引用了别的模块中的内容，那么上述编译和汇编过程中，将会保留特定的符号，在链接过程中将这些符号一一对应起来。
## 1.2 运行
### 1.2.1 CPU 执行
CPU 执行应用程序没有什么特别神秘的，它从机器码中解析出操作符和操作数完成相应的操作。CPU包含了若干个寄存器，所有的操作都是通过寄存器完成。
所有的指令和数据都是从内存中加载，由于 CPU 执行速度和内存的速度上巨大差异，现代CPU发展出高速缓存，由于局部性原理，刚刚访问的指令或者数据，其在不久的将来或者附近的指令都会被执行和访问。
### 1.2.2 内存使用
不管内存有多大，内存总是稀缺资源。早期的应用程序都是独占整个计算机内存，也就是物理内存，这样做有以下的潜在的问题：
- 如果应用程序需要的内存超出物理内存，将无法运行这个程序；
- 如果多道程序执行，如果不精心设计，将会导致互相影响。
现代执行应用程序，发展出虚拟内存和分页的机制，这样很好的解决了上述的问题。首先应用程序中的空间都是虚拟地址，其大小通常与机器位数有关，对于 64 位机器虚拟空间大小有 $2^{64} = 64$T。分页将虚拟地址空间和物理空间按照同样的大小划分，通常是 `4KB`。程序在运行的时候，只有一部分指令和数据需要执行，只需要它们在物理内存中即可。当物理内存不够的时候，将部分暂时不使用的内存页保存到磁盘中，将需要执行的页加载到物理内存即可。在 Linux 系统存放内存置换出来的磁盘叫做 `swap` 分区。CPU 执行的指令和数据的地址都是虚拟内存而真正执行的时候是物理内存地址，中间的转换过程有 CPU 的 `MMU` (Memory Manage  Unit) 部件管理。 
### 1.2.3 并发
进程和线程是程序运行过程中重要的概念，通常一个正在运行的程序叫做进程，进程有独立的虚拟地址空间，文件描述符和进程ID号。
# 2 目标文件

## 2.1 段表

## 2.2 符号表

# 3 静态链接

## 3.1 地址分配

## 3.2 重定位