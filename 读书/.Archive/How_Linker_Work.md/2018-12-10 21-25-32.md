---
date: 2018-12-10
status: public
tags: CSAPP
title: 连接器如何工作
---
# 1 编译程序
对于如下简单的C程序：
```c
// main.c
int sum(int *a, int n);
int array[2] = {1, 2};
int main()
{
    int val = sum(array, 2);
    return val
}
// sum.c
int sum(int *a, int n)
{
    int i, s = 0;
    for (i =0; i < n; i++){
        s += a[i]
    }
    return s;
}
```
使用`gcc`来编译成可执行程序：
```shell
gcc -Og -o prog main.c sum.c
```
那么完整的中间流程如下:
- C预处理器，将源程序`main.c`翻译成ASCII码中间文件
```shell
cpp [options] main.c /tmp/main.i
```
- C编译器，将`main.i`翻译成ASCII码的汇编语言文件`main.s`
```shell
cc1 /tmp/main.i -Og [options] -o /tmp/main.s
```
- 汇编器，将`main.s`翻译成可重定位文件`main.o`
```shell
as [options] -o /tmp/main.o /tmp/main.s
```
- 链接器，将可重定位文件和必要的系统文件合并起来，行程可执行文件
```shell
ld -o prog [system object files] /tmp/main.o /tmp/sum.o
```
- 加载器，将文件`prog`的代码和数据复制到内存中
```
linux> ./prog
```
# 2 目标文件
静态链接器以一组目标文件为输入，生成一个完全链接、可以加载和运行执行的目标文件。链接器完成两个工作：
- 符号解析：将目标文件中的每个符号引用和每个符号定义(`函数、全局变量、静态变量等`)关联起来；
- 重定位：每个符号定义与内存位置关联起来。
一般目标文件分为三种：
1. 可重定位目标文件
2. 可执行目标文件
3. 共享目标文件
在Linux或者Unix系统中，使用`ELF`(Executable and Linkable Format)作为目标文件的格式，典型的格式如下：

![](./_image/2018-12-10-21-24-42.jpg)
- `.text`:已
