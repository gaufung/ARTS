---
date: 2018-08-25
status: public
title: Tornado异步单元测试
---

# 1 前言
## 1.1 单元测试
关于单元测试的重要性不言而喻： `好的代码需要单元测试` -> `单元测试要求好的设计` -> `好的设计意味着解耦` -> `接口有助于解耦` -> `解耦有助于编写单元测试` -> `单元测试有助于编写好的代码`。
换一句话来讲，没有单元测试的代码是不值得信任的，而且编写单元测试也有助于他人理解代码，这个对团队开发是非常重要的。
## 1.2 `unittest` 包
`python`内置了`unittest`包，包含了通用的单元测试所需要的基本功能， 使用方法也非常简单：
```python
import unittest
class TestStringMethods(unittest.TestCase):
    def test_upper(self):
        self.assertEqual('foo'.upper(), 'FOO')
    def test_isupper(self):
        self.assertTrue('FOO'.isupper())
        self.assertFalse('Foo'.isupper())
    def test_split(self):
        s = 'hello world'
        self.assertEqual(s.split(), ['hello', 'world'])
        # check that s.split fails when the separator is not a string
        with self.assertRaises(TypeError):
            s.split(2)
if __name__ == '__main__':
    unittest.main()
```
每一个单元测试类继承`unittest.TestCase`，每一个测试方法以`test_`开头，`self.assert__`方法为单元测试判断比较。`unittest.main()`启动全部测试。在子类中可以重载`setUp`和`tearDown`方法，在这里可以做一些测试初始化和清理功能，比如数据路连接和关闭等等。一旦`assert`相关方法失败，则抛出异常。
## 1.3 代码覆盖率
单元测试还有一个很重要的目的是测试代码的覆盖率，`coverage`包提供了检查代码覆盖率的功能，而且能够输出网页版的查看工具。
```python
import unittest
import coverage
COV = None
COV = coverage.coverage(branch=True, include="./*", omit=["ENV/*", "_run.py", "test/*", "pep8/*", "*/__init__.py"])
COV.start()
def _test():
    tests = unittest.TestLoader().discover("test")
    unittest.TextTestRunner(verbosity=2).run(tests)
    COV.stop()
    COV.save()
    COV.report()
    basedir = os.path.abspath(os.path.dirname(__file__))
    covdir = os.path.join(basedir, "tmp/coverage")
    COV.html_report(directory=covdir)
    COV.erase()
```
`coverage`函数中`include`参数给出检查单元覆盖率的文件夹，`omit`参数给出忽略的文件夹。`html_report`将单元测试覆盖率输出到文件到指定文件夹中。在启动`_test`方法后，可以查看每一行代码是否被单元测试覆盖到。
# 2 异步方法测试
一般的方法编写测试非常简单，但是如果使用`tornado`编写的异步方法和函数该如何编写单元测试呢？没关系，`tornado`提供了`tornado.testing`包，包含了`AsyncTestCase`和`AsyncHTTPTestCase`类， 该类继承`unittest.TestCase`, 因此也包含了之前的`assert`相关的方法。`gen_test`装饰器用来异步的单元测试中，将`yield`的异步操作变成同步操作，该装饰器`timeout`参数用来指明这个异步单元测试方法的时间界限，超出时间将会引发单元测试失败异常。
```python
# func.py
from tornado.httpclient import HTTPRequest, AsyncHTTPClient
from tornado.gen import coroutine, Return
@coroutine
def run():
    request = HTTPRequest("https://gaufung.com")
    http_client = AsyncHTTPClient()
    response = yield http_client.fetch(request)
    raise Return(response.code)
    
# test_func.py
import unittest
from tornado.testing import AsyncTestCase, gen_test
from func import run
class TestFunc(AsyncTestCase):
    @gen_test(timeout=5)
    def test_run():
        code = yield run()
        self.assertEqual(code, 200)
```
每一个单元测试只能有一个`IOLoop`实例，如果在单元测试中使用`IOLoop`，则必须要重载`setUp`方法，否则将无法使用`self.io_loop`.
```python

```
# 3 Tornado应用API测试
# 4 异步方法Mock